
<!DOCTYPE html>
<html lang="en">
  <head profile="http://www.w3.org/2005/10/profile">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Starter Template for Bootstrap</title>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  </head>

  <style>
    html, body, #container {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    body {
      padding-top: 50px;
    }

    #map {
      width: auto;
      height: 100%;
    }

    #custom-search-input{
        padding: 3px;
        border: solid 1px #E4E4E4;
        border-radius: 6px;
        background-color: #fff;
    }

    #custom-search-input input{
        border: 0;
        box-shadow: none;
    }

    #custom-search-input button{
        margin: 2px 0 0 0;
        background: none;
        box-shadow: none;
        border: 0;
        color: #666666;
        padding: 0 8px 0 10px;
        border-left: solid 1px #ccc;
    }

    #custom-search-input button:hover{
        border: 0;
        box-shadow: none;
        border-left: solid 1px #ccc;
    }

    #custom-search-input .glyphicon-search{
        font-size: 23px;
    }
  
    #results {
      overflow-y: scroll;
      position: absolute;
      top: 68px;
      left: 15px;
      right: 15px;
      bottom: 0;
    }

    .list-group-item:hover {
      background: steelblue;
      color: #fff;
      cursor: pointer;
    }

    .info {
        padding: 6px 8px;
        font: 14px/18px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
    }


  </style>

  <body>

    <nav class="navbar navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">AMR Visualizer</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div id="container">
      <div class="col-md-3" style='height:100%'>
        <div id="custom-search-input">
            dropdowns will go here! 
        </div> 
        <br/>
          <ul id="results" class="list-group">
            
          </ul>
  
      </div>
      <div id="map">

      </div>


    </div><!-- /.container -->
    <script type="text/sql" id="sql-template">
<!--     SELECT a.cartodb_id, a.the_geom, a.the_geom_webmercator, a.name, b.avg_wkly_wage::bigint FROM cb_2014_us_county_20m a LEFT JOIN (SELECT * FROM chriswhong.table_2015_q1_q1_singlefile WHERE industry_code = '{{code}}') b ON a.geoid=b.area_fips -->


<!--     SELECT * FROM nrobson.wi_counties_amr_2009
 -->
    </script>
    <script type="text/cartocss" id="cartocss">

    #nrobson.wi_counties_amr_2009{
      polygon-fill: #CCCCCC;
      polygon-opacity: 0.8;
      line-color: #FFF;
      line-width: 0.5;
      line-opacity: 1;
    }
    #nrobson.wi_counties_amr_2009 [cipro09 <= 100] {
       polygon-fill: #43618F;
    }
    #nrobson.wi_counties_amr_2009 [ cipro09 <= 90] {
       polygon-fill: #4E71A6;
    }
    #nrobson.wi_counties_amr_2009 [ cipro09 <= 80] {
       polygon-fill: #6182B5;
    }
    #nrobson.wi_counties_amr_2009[ cipro09 <= 70] {
       polygon-fill: #849EC5;
    }
    #nrobson.wi_counties_amr_2009[ cipro09 <= 60] {
       polygon-fill: #9BB0D0;
    }
    #nrobson.wi_counties_amr_2009 [cipro09 = 0] {
       polygon-fill: #9BB0D0;
    }

</script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.2.0/mustache.min.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <script>
    var counties;

    var map = new L.Map('map', { 
      zoomControl: false,
      center: [43.7844,-88.7879],
      zoom: 7
    });

    new L.Control.Zoom({ position: 'topright' }).addTo(map);
    var info = L.control({ position: 'topleft' });



    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info'); 
        this.update('51512','Television Broadcasting');
        return this._div;
    };
    // This part should change based on what the user is viewing
    // Example: "Ciprofloxacin resistance in 2009" or "Levoflovain susceptibility in 2013"
    // method that we will use to update the control based on feature properties passed
    info.update = function (code, title) {
        this._div.innerHTML = Mustache.render('<h4>NIACS Code {{code}} - {{title}}</h4>',{ code:code, title:title });
    };

    info.addTo(map);

    L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',{
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
    }).addTo(map);

// this URL grabs his data from carto. How do I do the same thing?
    var layerUrl = 'https://team.cartodb.com/u/chriswhong/api/v2/viz/47f9b93e-9a36-11e5-bb29-0ecd1babdde5/viz.json';
    var sql = Mustache.render($('#sql-template').text(),{ code: '112210' })


    var cartocss = $('#cartocss').text();

//this code doesn't do anything...
    var layerSource = {
      user_name: 'nrobson',
      type: 'cartodb',
      sublayers: [{
        sql: sql,
        cartocss: cartocss
      }]
    }

    cartodb.createLayer(map, layerUrl)
      .addTo(map)
      .on('done', function(layer) {
        counties = layer.getSubLayer(0);
      }).on('error', function() {
        //log the error
      });

    $("#mainSearch").keyup(function (e) {
      if (e.keyCode == 13) {
        var q = $(this).val();
        console.log(q);
        $('#results').empty();
        lookupCodes(q);
      }
    });


    function lookupCodes(q) {
      var url = Mustache.render('http://api.naics.us/v0/s?year=2012&terms={{q}}',{ q:q });
      $.getJSON(url, function( data ) {
        populateResults(data);
      })
    }

    function populateResults(data) {

      data.forEach(function(naicsCode) {
       

        var snippet = Mustache.render('<li class="list-group-item"><span class="badge">{{code}}</span><div class="title">{{title}}</div></li>',naicsCode)

        $('#results').append(snippet);
      })

      $('.list-group-item').on('click', function() {
          var code = $(this).find('.badge').text();
          var title = $(this).find('.title').text();
          updateMap(code);
          info.update(code,title);
      });
    }
      
    function updateMap(code) {
      var sql = Mustache.render($('#sql-template').text(),{ code: code })
      counties.setSQL(sql);
    }



    </script>
  </body>
</html>